name: Versioning Packages

on:
  push:
    branches:
      - main
    tags-ignore:
      - '**'
concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Versioning
    if: github.ref_type == 'branch' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Use Node.js 22.x
        id: setup-node
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          registry-url: 'https://npm.pkg.github.com'
          cache: 'pnpm'

      - name: Setup GitHub CLI
        uses: sersoft-gmbh/setup-gh-cli-action@v2
        with:
          version: stable

      - name: Install Dependencies
        id: install
        run: |
          echo "‚è≥ Installing dependencies..."
          START_TIME=$(date +%s)

          pnpm install

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          # Capturar estat√≠sticas
          PACKAGE_COUNT=$(pnpm list --depth=0 --json 2>/dev/null | jq -r 'length' || echo "N/A")

          echo "duration=${DURATION}" >> $GITHUB_OUTPUT
          echo "package_count=${PACKAGE_COUNT}" >> $GITHUB_OUTPUT

      - name: Dependencies Summary
        run: |
          echo "### üîß Dependencies Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ‚úÖ Success" >> $GITHUB_STEP_SUMMARY
          echo "**Packages**: ${{ steps.install.outputs.package_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Duration**: ${{ steps.install.outputs.duration }}s" >> $GITHUB_STEP_SUMMARY
          echo "**Cache**: ${{ steps.setup-node.outputs.cache-hit == 'true' && '‚úÖ Hit' || '‚ö†Ô∏è Miss' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Create Release Pull Request Or Tag and Release
        id: changesets
        uses: changesets/action@v1
        with:
          title: "Version Apps"
          commit: "Version Apps"
          createGithubReleases: false
          publish: pnpm changeset:tag
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Changesets Summary
        run: |
          echo "### üè∑Ô∏è Changesets Processing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Detectar se foi criado PR ou tags
          if [ "${{ steps.changesets.outputs.published }}" == "true" ]; then
            echo "**Action**: ‚úÖ Tags Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Listar tags criadas no √∫ltimo commit
            TAGS=$(git tag --points-at HEAD)
            if [ -n "$TAGS" ]; then
              echo "**Tags Created**:" >> $GITHUB_STEP_SUMMARY
              for tag in $TAGS; do
                # Extrair app name e version
                APP=$(echo $tag | cut -d'@' -f1)
                VERSION=$(echo $tag | cut -d'@' -f2)

                # Detectar tipo de bump
                PREV_VERSION=$(git tag -l "${APP}@*" --sort=-version:refname | sed -n '2p' | cut -d'@' -f2)
                if [ -n "$PREV_VERSION" ]; then
                  BUMP_TYPE="patch"
                  V_MAJOR=$(echo $VERSION | cut -d'.' -f1)
                  V_MINOR=$(echo $VERSION | cut -d'.' -f2)
                  P_MAJOR=$(echo $PREV_VERSION | cut -d'.' -f1)
                  P_MINOR=$(echo $PREV_VERSION | cut -d'.' -f2)

                  if [ "$V_MAJOR" != "$P_MAJOR" ]; then
                    BUMP_TYPE="major üö®"
                  elif [ "$V_MINOR" != "$P_MINOR" ]; then
                    BUMP_TYPE="minor ‚ö°"
                  fi
                  echo "- \`$tag\` ($BUMP_TYPE)" >> $GITHUB_STEP_SUMMARY
                else
                  echo "- \`$tag\` (initial)" >> $GITHUB_STEP_SUMMARY
                fi
              done
            else
              echo "- No tags created" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "${{ steps.changesets.outputs.hasChangesets }}" == "true" ]; then
            echo "**Action**: ‚úÖ PR Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**PR**: #${{ steps.changesets.outputs.pullRequestNumber }}" >> $GITHUB_STEP_SUMMARY
            echo "**Link**: [View PR](https://github.com/${{ github.repository }}/pull/${{ steps.changesets.outputs.pullRequestNumber }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Action**: ‚è≠Ô∏è No changesets found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No version bumps needed." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Push tags
        id: push-tags
        if: steps.changesets.outputs.published == 'true'
        run: |
          echo "‚è≥ Pushing tags to remote..."

          # Capturar tags antes do push
          TAGS_TO_PUSH=$(git tag --points-at HEAD)

          # Push tags
          git push --tags

          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS_TO_PUSH" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Push Tags Summary
        if: steps.changesets.outputs.published == 'true'
        run: |
          echo "### üì§ Tags Pushed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TAGS="${{ steps.push-tags.outputs.tags }}"
          if [ -n "$TAGS" ]; then
            echo "**Status**: ‚úÖ Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Tags**:" >> $GITHUB_STEP_SUMMARY
            for tag in $TAGS; do
              echo "- ‚úÖ \`$tag\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "**Status**: ‚è≠Ô∏è No tags to push" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Create GitHub Releases from tags
        if: steps.changesets.outputs.published == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node scripts/create-releases.js

      - name: Workflow Summary
        if: always()
        run: |
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: [\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
